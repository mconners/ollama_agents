events {
    worker_connections 1024;
}

http {
    upstream ollama_backend {
        server ollama-main-agx0:11434;
        server 192.168.1.147:11435 backup;  # PI51 Primary
        server 192.168.1.157:11434 backup;  # ORIN0 Secondary
    }

    upstream jupyter_backend {
        server jupyter-ai-agx0:8888;
    }

    server {
        listen 80;
        server_name agx0-api.local 192.168.1.154;

        # Main AI API endpoint
        location /api/ {
            proxy_pass http://ollama_backend/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Increase timeouts for AI processing
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }

        # Jupyter Lab interface
        location /jupyter/ {
            proxy_pass http://jupyter_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Jupyter
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Remove /jupyter prefix
            rewrite ^/jupyter/(.*) /$1 break;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "AGX0 Primary AI Node - Healthy\n";
            add_header Content-Type text/plain;
        }

        # Prometheus metrics
        location /metrics {
            proxy_pass http://prometheus-agx0:9090/metrics;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Default status page
        location / {
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>AGX0 Primary AI Node</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .endpoint { background: #ecf0f1; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .endpoint a { color: #3498db; text-decoration: none; }
        .endpoint a:hover { text-decoration: underline; }
        .status { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ AGX0 Primary AI Node</h1>
            <p>NVIDIA Jetson Orin AGX - Main AI Processing Center</p>
            <p class="status">Status: Online</p>
        </div>
        
        <div class="endpoint">
            <h3>ðŸ¤– Main Ollama API</h3>
            <p><a href="/api/tags">/api/tags</a> - Available AI models</p>
            <p><a href="/api/version">/api/version</a> - Ollama version info</p>
        </div>
        
        <div class="endpoint">
            <h3>ðŸ“Š Jupyter AI Lab</h3>
            <p><a href="/jupyter/" target="_blank">/jupyter/</a> - AI development environment</p>
            <p>Token: ollama_cluster_2025</p>
        </div>
        
        <div class="endpoint">
            <h3>ðŸ“ˆ Monitoring</h3>
            <p><a href="/metrics">/metrics</a> - Prometheus metrics</p>
            <p><a href="/health">/health</a> - Health check</p>
        </div>
        
        <div class="endpoint">
            <h3>ðŸ”— Cluster Links</h3>
            <p><a href="http://192.168.1.147:8080" target="_blank">Gateway Dashboard</a> - Traefik load balancer</p>
            <p><a href="http://192.168.1.157:3001" target="_blank">ORIN0 Code Server</a> - Development environment</p>
        </div>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }
    }
}
